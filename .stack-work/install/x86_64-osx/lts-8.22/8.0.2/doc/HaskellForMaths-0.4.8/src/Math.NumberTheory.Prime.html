<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- Copyright (c) 2006-2011, David Amos. All rights reserved.</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE NoMonomorphismRestriction #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- |A module providing functions to test for primality, and find next and previous primes.</span><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Math</span><span class="hs-operator">.</span><span class="hs-identifier">NumberTheory</span><span class="hs-operator">.</span><span class="hs-identifier">Prime</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Prime.html#primes"><span class="hs-identifier hs-var">primes</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Prime.html#isTrialDivisionPrime"><span class="hs-identifier hs-var">isTrialDivisionPrime</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Prime.html#isMillerRabinPrime"><span class="hs-identifier hs-var">isMillerRabinPrime</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>                                </span><a href="Math.NumberTheory.Prime.html#isPrime"><span class="hs-identifier hs-var">isPrime</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Prime.html#notPrime"><span class="hs-identifier hs-var">notPrime</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Prime.html#prevPrime"><span class="hs-identifier hs-var">prevPrime</span></a><span class="hs-special">,</span><span> </span><a href="Math.NumberTheory.Prime.html#nextPrime"><span class="hs-identifier hs-var">nextPrime</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Unsafe</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><a name="isTrialDivisionPrime"><a href="Math.NumberTheory.Prime.html#isTrialDivisionPrime"><span class="hs-identifier">isTrialDivisionPrime</span></a></a><span> </span><a name="local-6989586621679032671"><a href="#local-6989586621679032671"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-14"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679032671"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679032672"><a href="#local-6989586621679032672"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679032671"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">rem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679032672"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679033224"><a href="#local-6989586621679033224"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679033224"><span class="hs-identifier hs-var">p</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033224"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679032671"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Prime.html#primes"><span class="hs-identifier hs-var">primes</span></a><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-comment">-- |A (lazy) list of the primes</span><span>
</span><a name="line-18"></a><span class="hs-identifier">primes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Integer</span><span class="hs-special">]</span><span>
</span><a name="line-19"></a><a name="primes"><a href="Math.NumberTheory.Prime.html#primes"><span class="hs-identifier">primes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679033225"><span class="hs-identifier hs-var">isPrime</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">5</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>    </span><a name="local-6989586621679033225"><a href="#local-6989586621679033225"><span class="hs-identifier">isPrime</span></a></a><span> </span><a name="local-6989586621679033226"><a href="#local-6989586621679033226"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679033227"><a href="#local-6989586621679033227"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679033226"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">rem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679033227"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679033228"><a href="#local-6989586621679033228"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679033228"><span class="hs-identifier hs-var">p</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033228"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679033226"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Prime.html#primes"><span class="hs-identifier hs-var">primes</span></a><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">{-
-- This is just marginally faster, but less elegant
primes2 :: [Integer]
primes2 = 2 : 3 : 5 : 7 : filter isPrime
    (concat [ [m30+11,m30+13,m30+17,m30+19,m30+23,m30+29,m30+31,m30+37] | m30 &lt;- [0,30..] ])
    where isPrime n = not $ any (\p -&gt; n `rem` p == 0) (takeWhile (\p -&gt; p*p &lt;= n) primes2')
          primes2' = drop 3 primes2
-}</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-comment">{-
-- initial version. This isn't going to be very good if n has any &quot;large&quot; prime factors (eg &gt; 10000)
pfactors1 n | n &gt; 0 = pfactors' n primes
            | n &lt; 0 = -1 : pfactors' (-n) primes
    where pfactors' n (d:ds) | n == 1 = []
                             | n &lt; d*d = [n]
                             | r == 0 = d : pfactors' q (d:ds)
                             | otherwise = pfactors' n ds
                             where (q,r) = quotRem n d
-}</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">-- MILLER-RABIN TEST</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- Cohen, A Course in Computational Algebraic Number Theory, p422</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- Koblitz, A Course in Number Theory and Cryptography</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span class="hs-comment">-- Let n-1 = 2^s * q, q odd</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- Then n is a strong pseudoprime to base b if</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- either b^q == 1 (mod n)</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- or b^(2^r * q) == -1 (mod n) for some 0 &lt;= r &lt; s</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- (For we know that if n is prime, then b^(n-1) == 1 (mod n)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><a name="isStrongPseudoPrime"><a href="Math.NumberTheory.Prime.html#isStrongPseudoPrime"><span class="hs-identifier">isStrongPseudoPrime</span></a></a><span> </span><a name="local-6989586621679033229"><a href="#local-6989586621679033229"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679033230"><a href="#local-6989586621679033230"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679033231"><a href="#local-6989586621679033231"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033232"><a href="#local-6989586621679033232"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Prime.html#split2s"><span class="hs-identifier hs-var">split2s</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033229"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- n-1 == 2^s * q, with q odd</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Math.NumberTheory.Prime.html#isStrongPseudoPrime%27"><span class="hs-identifier hs-var">isStrongPseudoPrime'</span></a><span> </span><a href="#local-6989586621679033229"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033231"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><a href="#local-6989586621679033232"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679033230"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><a name="isStrongPseudoPrime%27"><a href="Math.NumberTheory.Prime.html#isStrongPseudoPrime%27"><span class="hs-identifier">isStrongPseudoPrime'</span></a></a><span> </span><a name="local-6989586621679033233"><a href="#local-6989586621679033233"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679033234"><a href="#local-6989586621679033234"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033235"><a href="#local-6989586621679033235"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679033236"><a href="#local-6989586621679033236"><span class="hs-identifier">b</span></a></a><span>
</span><a name="line-58"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033237"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-59"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033233"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679033238"><span class="hs-identifier hs-var">squarings</span></a><span>
</span><a name="line-60"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679033237"><a href="#local-6989586621679033237"><span class="hs-identifier">b'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Prime.html#power_mod"><span class="hs-identifier hs-var">power_mod</span></a><span> </span><a href="#local-6989586621679033236"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621679033235"><span class="hs-identifier hs-var">q</span></a><span> </span><a href="#local-6989586621679033233"><span class="hs-identifier hs-var">n</span></a><span>     </span><span class="hs-comment">-- b' = b^q `mod` n</span><span>
</span><a name="line-61"></a><span>          </span><a name="local-6989586621679033238"><a href="#local-6989586621679033238"><span class="hs-identifier">squarings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621679033234"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">iterate</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679033239"><a href="#local-6989586621679033239"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679033239"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033239"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mod</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679033233"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679033237"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-comment">-- b^(2^r *q) for 0 &lt;= r &lt; s</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-comment">-- split2s 0 m returns (s,t) such that 2^s * t == m, t odd</span><span>
</span><a name="line-64"></a><a name="split2s"><a href="Math.NumberTheory.Prime.html#split2s"><span class="hs-identifier">split2s</span></a></a><span> </span><a name="local-6989586621679033240"><a href="#local-6989586621679033240"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621679033241"><a href="#local-6989586621679033241"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679033242"><a href="#local-6989586621679033242"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033243"><a href="#local-6989586621679033243"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033241"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-65"></a><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033243"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="Math.NumberTheory.Prime.html#split2s"><span class="hs-identifier hs-var">split2s</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033240"><span class="hs-identifier hs-var">s</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679033242"><span class="hs-identifier hs-var">q</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033240"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><a href="#local-6989586621679033241"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">-- power_mod b t n == b^t mod n</span><span>
</span><a name="line-68"></a><a name="power_mod"><a href="Math.NumberTheory.Prime.html#power_mod"><span class="hs-identifier">power_mod</span></a></a><span> </span><a name="local-6989586621679033244"><a href="#local-6989586621679033244"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679033245"><a href="#local-6989586621679033245"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621679033246"><a href="#local-6989586621679033246"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033247"><span class="hs-identifier hs-var">powerMod'</span></a><span> </span><a href="#local-6989586621679033244"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621679033245"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679033247"><a href="#local-6989586621679033247"><span class="hs-identifier">powerMod'</span></a></a><span> </span><a name="local-6989586621679033248"><a href="#local-6989586621679033248"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679033249"><a href="#local-6989586621679033249"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033249"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-70"></a><span>          </span><span class="hs-identifier">powerMod'</span><span> </span><a name="local-6989586621679033250"><a href="#local-6989586621679033250"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679033251"><a href="#local-6989586621679033251"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679033252"><a href="#local-6989586621679033252"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679033253"><a href="#local-6989586621679033253"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033254"><a href="#local-6989586621679033254"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033252"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">quotRem</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-71"></a><span>                            </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679033247"><span class="hs-identifier hs-var">powerMod'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033250"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033250"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">rem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679033246"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033254"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621679033251"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679033250"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033251"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">rem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679033246"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679033253"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><a name="isMillerRabinPrime%27"><a href="Math.NumberTheory.Prime.html#isMillerRabinPrime%27"><span class="hs-identifier">isMillerRabinPrime'</span></a></a><span> </span><a name="local-6989586621679033255"><a href="#local-6989586621679033255"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033255"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-75"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679033256"><a href="#local-6989586621679033256"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033257"><a href="#local-6989586621679033257"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Prime.html#split2s"><span class="hs-identifier hs-var">split2s</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033255"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- n-1 == 2^s * q, with q odd</span><span>
</span><a name="line-76"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679033258"><a href="#local-6989586621679033258"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getStdGen</span><span>
</span><a name="line-77"></a><span>              </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679033259"><a href="#local-6989586621679033259"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">randomRs</span><span> </span><span class="hs-special">(</span><span class="hs-number">2</span><span class="hs-special">,</span><a href="#local-6989586621679033255"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679033258"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-78"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Prime.html#isStrongPseudoPrime%27"><span class="hs-identifier hs-var">isStrongPseudoPrime'</span></a><span> </span><a href="#local-6989586621679033255"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033256"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><a href="#local-6989586621679033257"><span class="hs-identifier hs-var">q</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-number">25</span><span> </span><a href="#local-6989586621679033259"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033255"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-80"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- Cohen states that if we restrict our rs to single word numbers, we can use a more efficient powering algorithm</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- isMillerRabinPrime :: Integer -&gt; Bool</span><span>
</span><a name="line-84"></a><a name="isMillerRabinPrime"><a href="Math.NumberTheory.Prime.html#isMillerRabinPrime"><span class="hs-identifier">isMillerRabinPrime</span></a></a><span> </span><a name="local-6989586621679033260"><a href="#local-6989586621679033260"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-special">(</span><a href="Math.NumberTheory.Prime.html#isMillerRabinPrime%27"><span class="hs-identifier hs-var">isMillerRabinPrime'</span></a><span> </span><a href="#local-6989586621679033260"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-comment">-- |Is this number prime? The algorithm consists of using trial division to test for very small factors,</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- followed if necessary by the Miller-Rabin probabilistic test.</span><span>
</span><a name="line-89"></a><span class="hs-identifier">isPrime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-90"></a><a name="isPrime"><a href="Math.NumberTheory.Prime.html#isPrime"><span class="hs-identifier">isPrime</span></a></a><span> </span><a name="local-6989586621679033261"><a href="#local-6989586621679033261"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033261"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679033262"><span class="hs-identifier hs-var">isPrime'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">100</span><span class="hs-special">)</span><span> </span><a href="Math.NumberTheory.Prime.html#primes"><span class="hs-identifier hs-var">primes</span></a><span>
</span><a name="line-91"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679033262"><a href="#local-6989586621679033262"><span class="hs-identifier">isPrime'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679033263"><a href="#local-6989586621679033263"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679033264"><a href="#local-6989586621679033264"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033261"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621679033263"><span class="hs-identifier hs-var">d</span></a><span class="hs-operator hs-var">*</span><a href="#local-6989586621679033263"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-93"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679033265"><a href="#local-6989586621679033265"><span class="hs-identifier">q</span></a></a><span class="hs-special">,</span><a name="local-6989586621679033266"><a href="#local-6989586621679033266"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotRem</span><span> </span><a href="#local-6989586621679033261"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621679033263"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-94"></a><span>                                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679033266"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679033262"><span class="hs-identifier hs-var">isPrime'</span></a><span> </span><a href="#local-6989586621679033264"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-95"></a><span>          </span><span class="hs-identifier">isPrime'</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Math.NumberTheory.Prime.html#isMillerRabinPrime"><span class="hs-identifier hs-var">isMillerRabinPrime</span></a><span> </span><a href="#local-6989586621679033261"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- the &lt; 100 is found heuristically to be about the point at which trial division stops being worthwhile</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-identifier">notPrime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-99"></a><a name="notPrime"><a href="Math.NumberTheory.Prime.html#notPrime"><span class="hs-identifier">notPrime</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Math.NumberTheory.Prime.html#isPrime"><span class="hs-identifier hs-var">isPrime</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- |Given n, @prevPrime n@ returns the greatest p, p &lt; n, such that p is prime</span><span>
</span><a name="line-102"></a><span class="hs-identifier">prevPrime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-103"></a><a name="prevPrime"><a href="Math.NumberTheory.Prime.html#prevPrime"><span class="hs-identifier">prevPrime</span></a></a><span> </span><a name="local-6989586621679033267"><a href="#local-6989586621679033267"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033267"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Math.NumberTheory.Prime.html#isPrime"><span class="hs-identifier hs-var">isPrime</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679033269"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-104"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033267"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;prevPrime: no previous primes&quot;</span><span>
</span><a name="line-105"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033267"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-106"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-107"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679033268"><a href="#local-6989586621679033268"><span class="hs-identifier">n6</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033267"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">6</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-108"></a><span>                  </span><a name="local-6989586621679033269"><a href="#local-6989586621679033269"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621679033267"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679033270"><span class="hs-identifier hs-var">m6</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">5</span><span class="hs-special">,</span><a href="#local-6989586621679033270"><span class="hs-identifier hs-var">m6</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679033270"><a href="#local-6989586621679033270"><span class="hs-identifier">m6</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679033268"><span class="hs-identifier hs-var">n6</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679033268"><span class="hs-identifier hs-var">n6</span></a><span class="hs-glyph">-</span><span class="hs-number">6</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- |Given n, @nextPrime n@ returns the least p, p &gt; n, such that p is prime</span><span>
</span><a name="line-111"></a><span class="hs-identifier">nextPrime</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span>
</span><a name="line-112"></a><a name="nextPrime"><a href="Math.NumberTheory.Prime.html#nextPrime"><span class="hs-identifier">nextPrime</span></a></a><span> </span><a name="local-6989586621679033271"><a href="#local-6989586621679033271"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033271"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-113"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679033271"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-114"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Math.NumberTheory.Prime.html#isPrime"><span class="hs-identifier hs-var">isPrime</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679033273"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-115"></a><span>            </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679033272"><a href="#local-6989586621679033272"><span class="hs-identifier">n6</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679033271"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">6</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">6</span><span>
</span><a name="line-116"></a><span>                  </span><a name="local-6989586621679033273"><a href="#local-6989586621679033273"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621679033271"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679033274"><span class="hs-identifier hs-var">m6</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621679033274"><span class="hs-identifier hs-var">m6</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">5</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621679033274"><a href="#local-6989586621679033274"><span class="hs-identifier">m6</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679033272"><span class="hs-identifier hs-var">n6</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679033272"><span class="hs-identifier hs-var">n6</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">6</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">{-
-- slightly better version. This is okay so long as n has at most one &quot;large&quot; prime factor (&gt; 10000)
-- if it has more, it does at least tell you, via an error message, that it has run into difficulties
pfactors2 n | n &gt; 0 = pfactors' n $ takeWhile (&lt; 10000) primes
            | n &lt; 0 = -1 : pfactors' (-n) (takeWhile (&lt; 10000) primes)
    where pfactors' n (d:ds) | n == 1 = []
                             | n &lt; d*d = [n]
                             | r == 0 = d : pfactors' q (d:ds)
                             | otherwise = pfactors' n ds
                             where (q,r) = quotRem n d
          pfactors' n [] = if isMillerRabinPrime n then [n] else error (&quot;pfactors2: can't factor &quot; ++ show n)
-}</span><span>
</span><a name="line-130"></a></pre></body></html>